<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, minimal-ui">

    <title>Trump World</title>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.3/fastclick.min.js"></script>
    <script type="text/javascript" src="assets/js/jquery/dist/jquery.min.js"></script>
    <script src="assets/css/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
    <script src="assets/css/bootstrap-material-design/dist/js/material.min.js"></script>
    <script src="assets/css/bootstrap-material-design/dist/js/ripples.min.js"></script>
    <script type="text/javascript" src="assets/js/ngraphForceLayoutOptions.js"></script>
    <script type="text/javascript" src="assets/js/cytoscape/dist/cytoscape.min.js"></script>
    <script type="text/javascript" src="assets/js/cytoscape-graphml/cytoscape-graphml.js"></script>
    <script type="text/javascript" src="assets/js/cytoscape-ngraph.forcelayout/cytoscape-ngraph.forcelayout.js"></script>
    <script type="text/javascript" src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="assets/js/graphDataView.js"></script>
    <script type="text/javascript" src="assets/js/slidereveal.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.min.js"></script>
    <script src="https://cdn.rawgit.com/cytoscape/cytoscape.js-qtip/2.2.5/cytoscape-qtip.js"></script>

    <link href="https://fonts.googleapis.com/css?family=Metrophobic" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link href="assets/css/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.min.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="assets/css/bootstrap-3.3.7-dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="assets/css/bootstrap-material-design/dist/css/bootstrap-material-design.css">
    <link rel="stylesheet" type="text/css" href="assets/css/bootstrap-material-design/dist/css/ripples.min.css">
    <link href="assets/css/styles.css" rel="stylesheet" />

    <!-- Material Design for Bootstrap -->
    <script>
        $.material.init();
    </script>

</head>

<body>
    <div class="container-fluid">
        <div id="loading">
            <span class="fa fa-refresh fa-spin"></span>
        </div>
        <row class="card jumbotron">
            <div class="col-md-12 col-lg-12 col-sm-12">
                <h2 class=" title">Mapping The Trump World</h2>
            </div>            
        </row>
        <row>
            <div class="col-md-8 col-lg-8 col-sm-8">
                <div class="card btn-group btn-group-justified">
                    <a href="javascript:void(0)" class="btn " id="graph_viz_btn">Trump World</a>
                    <a href="javascript:void(0)" class="btn " id="adj_matrix_btn">Adjacency Matrix</a>
                    <a href="javascript:void(0)" class="btn " id="rankings_btn">Rankings</a>
                    <a href="javascript:void(0)" class="btn " id="graph_data_btn">Graph Data</a>
                    <a href="javascript:void(0)" class="btn " id="help_btn">About</a>
                </div>
            </div>
            <div class="col-md-1 col-lg-1 col-sm-1 col-md-offset-1 col-lg-offset-1 col-sm-offset-1"> 
                <div class="btn-group btn-group-justified">               
                    <button id="reset" class="btn btn-sm"><i class="material-icons ">aspect_ratio</i></button>                
                    <button id="refresh" class="btn btn-sm"><i class="material-icons" >refresh</i></button>
                </div>                 
            </div>
            <div id="trigger" class="col-md-2 col-lg-2 col-sm-2 ">
                <a href="javascript:void(0)" class="card btn btn-danger btn-lg btn-block btn-raised">Analysis</a>    
            </div>
            
        </row>
        <row id="home">
            <div class="col-md-12 col-lg-12 col-sm-12">
                <div class="panel panel-primary">
                    <div id="cy_container">
                        <div id="cy"></div>
                    </div>
                    
                    <div id="adj_matrix_container">
                        <div id="adj_matrix">
                            
                        </div>
                    </div>

                    <div id="rankings_container">
                        <div id="rankings">
                            Rankings and Adjacency Matrix go here.
                        </div>
                    </div>

                    <div id="graph_data_container">
                        <div id="graph_data">
                            
                        </div>
                    </div>

                    <div id="help_container">
                        <div id="help">
                            Help the user figure this site out.
                        </div>
                    </div>
                </div>
            </div>            
        </row>
    </div>
    <div class="card" id="slider">
        <div id="filters">
            <row class="vertical-align">
                <div class="col-md-2 col-lg-2 col-sm-2">
                    <i class="material-icons" style="text-align:left;font-size:40px;border:3px solid #232C96;color:#232C96;">search</i>
                </div>
                <div class="col-md-5 col-lg-5 col-sm-5">
                    <div class="form-group label-static has-info">
                        <label for="startNode" class="control-label">Start At</label>
                        <input type="text" class="form-control" id="startNode" style="font-size:14px;color:#111;">
                    </div>
                </div>
                <div class="col-md-5 col-lg-5 col-sm-5">
                    <div class="form-group label-static has-info">
                        <label for="endNode" class="control-label">End At</label>
                        <input type="text" class="form-control" id="endNode" style="font-size:14px;color:#111;">
                    </div>
                </div>
            </row>
            <row class="vertical-align">
                <div class="col-md-2 col-lg-2 col-sm-2">
                    <i class="material-icons" style="text-align:left;font-size:40px;border:3px solid #F93324;color:#F93324;">zoom_in</i>
                </div>
                <div class="col-md-9 col-lg-9 col-sm-9">
                    <div class="form-group label-static has-error">
                        <label for="focusOn" class="control-label">Focus On</label>
                        <input type="text" class="form-control" id="focusOn" style="font-size:14px;color:#111;">
                    </div>
                </div>
            </row>
            <row class="vertical-align">
                <div class="col-md-2 col-lg-2 col-sm-2">
                    <i class="fa fa-bullseye focusOnIcon"></i>
                </div>
                <div class="col-md-10 col-lg-10 col-sm-10">
                    <div class="form-group label-static has-success">
                        <label for="resizeNodes" class="control-label">Resize Nodes</label>
                        <select id="resizeNodes" class="form-control" style="font-size:14px;color:#111;">
                            <option value="">Select</option>
                            <option value="degree"> Most Connected (Degree) </option>
                            <option value="betweeness"> Most Paths (Betweeness) </option>
                            <option value="closeness"> Most Reach (Closeness) </option>
                        </select>
                    </div>
                </div>
            </row>
            <row class="vertical-align">
                <div class="col-md-2 col-lg-2 col-sm-2">
                    <i class="fa fa-bullseye focusOnIcon"></i>
                </div>
                <div class="col-md-10 col-lg-10 col-sm-10">
                    <div class="form-group label-static has-success">
                        <fieldset id="nodeTypeFilters">
                            <legend class="control-label"> Filter away: </legend>
                            <input type="checkbox" id="organization" name="nodeTypeFilter" value="Organization" checked="true" />
                            <label for="organization"> Organization </label>
                            <input type="checkbox" id="person" name="nodeTypeFilter" value="Person" checked="true"/>
                            <label for="person"> Person </label>
                            <input type="checkbox" id="contract" name="nodeTypeFilter" value="Contract" checked="true"/>
                            <label for="contract"> Contract </label>
                            <input type="checkbox" id="agency" name="nodeTypeFilter" value="Agency" checked="true"/>
                            <label for="agency"> Agency </label>
                            <input type="checkbox" id="country" name="nodeTypeFilter" value="Country" checked="true"/>
                            <label for="country"> Country </label>
                        </fieldset>                        
                    </div>
                </div>
            </row>
            <row class="vertical-align">
                <div class="col-md-2 col-lg-2 col-sm-2">
                    <i class="fa fa-bullseye focusOnIcon"></i>
                </div>
                <div class="col-md-10 col-lg-10 col-sm-10">
                    <div class="form-group label-static has-success">
                        <label for="resizeNodes" class="control-label">Export As</label>
                        <select id="resizeNodes" class="form-control" style="font-size:14px;color:#111;">
                            <option value="">Select</option>
                            <option value="png"> PNG </option>
                            <option value="svg"> SVG </option>
                            <option value="graphml"> GraphML </option>
                        </select>
                    </div>
                </div>
            </row>
        </div>
    </div>

    <script type="text/javascript">
        var win = $(window);
        var allNodes = null;
        var allEles = null;
        var lastHighlighted = null;
        var lastUnhighlighted = null;
        $('#slider').hide();

        $(function() {          

            "use strict";
            var $loading = $('#loading');

            var graphP = $.ajax({
                url: 'assets/data/trump-world.json',
                type: 'GET',
                dataType: 'json'
            });
            // also get style via ajax
            var styleP = $.ajax({
                url: 'assets/graph-layout-styles.txt',
                type: 'GET',
                dataType: 'text'
            });
            
            // when both graph export json and style loaded, init cy
            Promise.all([graphP, styleP]).then(initCy);

            function initCy(then) {
                console.log("In Init CY");

                var styleJson = then[1];
                var graphElements = then[0];                
                var cy = window.cy = cytoscape({
                    headless: false,
                    styleEnabled: true,
                    container: $("#cy"),
                    elements: graphElements,
                    style: styleJson,
                    layout: layoutOptions,
                    motionBlur: true,
                    zoom: 0.05,
                    pan: { x: 0, y: 0 },
                    minZoom: 1e-50,
                    maxZoom: 1e50,
                    zoomingEnabled: true,
                    userZoomingEnabled: true,
                    panningEnabled: true,
                    userPanningEnabled: true,
                    boxSelectionEnabled: true,
                    selectionType: 'single',
                    touchTapThreshold: 8,
                    desktopTapThreshold: 4,
                    autolock: false,
                    autoungrabify: false,
                    autounselectify: false,
                    ready: function() {
                        $("#cy_container").height(win.innerHeight() - 130);
                        this.resize();
                        allNodes = cy.nodes();
                        allEles = cy.elements();
                        $loading.addClass('loaded');
                        $('#slider').show();
                        $('#viewPort').show();
                        this.center();
                    } 

                });                               

                win.resize(function() {
                    $("#cy_container").height(win.innerHeight() - 130);
                    cy.resize();
                });

                d3.csv('assets/data/org-org-connections.csv',function (data) {
                    var columns = ['Organization A','Organization B','Connection','Source(s)'];
                    tabulate(data,columns);
                });

                $('#slider').slideReveal({
                    trigger: $("#trigger"),
                    position: "right",
                    width: "26%",
                    top: 180,
                    push: false,
                    overlay: true,
                    autoEscape: true                
                });


                /**********************************************************************/
                /*** On Click of Trump World show Cytoscape Container       ***********/

                $("#graph_viz_btn").click(function() {
                    $("#cy_container").show();
                    $("#trigger").show();
                    $('#reset').show();
                    $("#adj_matrix_container").hide();
                    $("#graph_data_container").hide();
                    $("#help_container").hide();
                    $("#rankings_container").hide();    
                });

                /**********************************************************************/
                /*** On Click of Rankings show Rankings Container           ***********/

                $("#rankings_btn").click(function() {
                    $("#cy_container").hide();
                    $("#trigger").hide();
                    $('#reset').hide();
                    $("#adj_matrix_container").hide();
                    $("#graph_data_container").hide();
                    $("#help_container").hide();
                    $("#rankings_container").show();    
                });

                /**********************************************************************/
                /*** On Click of Description show Description Container           ***********/

                $("#adj_matrix_btn").click(function() {
                    $("#cy_container").hide();
                    $("#trigger").hide();
                    $('#reset').hide();
                    $("#adj_matrix_container").show();
                    $("#graph_data_container").hide();
                    $("#help_container").hide();
                    $("#rankings_container").hide();    
                });

                /**********************************************************************/
                /*** On Click of Graph Data show Graph Data Container           ***********/

                $("#graph_data_btn").click(function() {

                    $("#cy_container").hide();
                    $("#trigger").hide();
                    $('#reset').hide();
                    $("#adj_matrix_container").hide();
                    $("#graph_data_container").show();
                    $("#help_container").hide();
                    $("#rankings_container").hide();

                });

                /**********************************************************************/
                /*** On Click of Help show Help Container           ***********/

                $("#help_btn").click(function() {
                    $("#cy_container").hide();
                    $("#trigger").hide();
                    $('#reset').hide();
                    $("#adj_matrix_container").hide();
                    $("#graph_data_container").hide();
                    $("#help_container").show();
                    $("#rankings_container").hide();    
                });

                $("#reset").on('click', function() {
                    cy.zoom(0.05);
                    cy.center();
                    this.blur();
                }); 

                $("#refresh").on('click', function() {
                    $('body').removeClass('has-start has-end');
                    cy.elements().removeClass('path not-path start end');
                });         

                /**********************************************************************/
                /*      Apply Node Type Based Filter                                  */
                $("#nodeTypeFilters").on('change', 'input', function() {
                    var noOrg         = $("#organization").is(':checked');
                    var noPerson     = $("#person").is(':checked');
                    var noAgency      = $("#agency").is(':checked');
                    var noCountry     = $("#country").is(':checked');
                    var noContract    = $("#contract").is(':checked');
                    cy.batch (function() {
                        allNodes.forEach ( n => { 
                            var type = n.data("label");                            
                            n.removeClass('filtered');
                            var filter = function(){
                              n.addClass('filtered');
                            };
                            if (n.data("label") === "Organization" && !noOrg 
                                || n.data("label") === "Person" && !noPerson
                                || n.data("label") === "Agency" && !noAgency
                                || n.data("label") === "Contract" && !noContract) {
                                filter();
                            }
                        });

                    });
                });

                $("#endNode").on('change', function() {
                    if ($("#startNode").val() === "" || $("#startNode").val() === undefined) {
                        alert("Please enter a value for the starting node.");
                    } else {
                        let start = cy.$("[name = '" + $("#startNode").val().toUpperCase() + "']");
                        let end = cy.$("[name = '" + $("#endNode").val().toUpperCase() + "']");
                        console.log(start);
                        console.log(end);

                        // calculate shortest path
                        cy.startBatch();
                        end.addClass('end');

                        setTimeout (function() {
                            var aStar = cy.elements().aStar({
                                root: start,
                                goal: end,
                                directed: false,
                                weight: function( e ) { 
                                    return 1;
                                      // if( e.data('is_walking') ){
                                      //   return 0.25; // assume very little time to walk inside stn
                                      // }
                                      
                                      // return e.data('is_bullet') ? 1 : 3; // assume bullet is ~3x faster
                                }
                            });                             
                            if ( !aStar.found ) {
                                $("body").removeClass('calc');
                                clear();

                                cy.endBatch();
                                return;
                            }

                            cy.elements().not( aStar.path ).addClass('not-path');
                            aStar.path.addClass('path');

                            cy.endBatch();

                            $('body').removeClass('calc');
                        }, 300);
                    }

                });

            }


        });

    </script>
</body>

</html>
