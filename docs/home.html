<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, minimal-ui">

    <title>Trump World</title>
    <script type="text/javascript" src="assets/js/fastclick.min.js"></script>
    <script type="text/javascript" src="assets/js/jquery/dist/jquery.min.js"></script>
    <script src="assets/css/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
    <script src="assets/css/bootstrap-material-design/dist/js/material.min.js"></script>
    <script src="assets/css/bootstrap-material-design/dist/js/ripples.min.js"></script>
    <script type="text/javascript" src="assets/js/ngraphForceLayoutOptions.js"></script>
    <script type="text/javascript" src="assets/js/cytoscape/dist/cytoscape.min.js"></script>
    <script type="text/javascript" src="assets/js/cytoscape-graphml/cytoscape-graphml.js"></script>
    <script type="text/javascript" src="assets/js/cytoscape-ngraph.forcelayout/cytoscape-ngraph.forcelayout.js"></script>
    <!-- <script type="text/javascript" src="assets/js/cytoscape-cola/cola.js"></script>
    <script type="text/javascript" src="assets/js/cytoscape-cola/cytoscape-cola.js"></script> -->
    <script type="text/javascript" src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="assets/js/graphDataView.js"></script>
    <script type="text/javascript" src="assets/js/slidereveal.js"></script>
    <script type="text/javascript" src="assets/js/jquery.qtip.min.js"></script>
    <link href="assets/css/jquery.qtip.min.css" rel="stylesheet" />
    <script type="text/javascript" src="assets/js/cytoscape-qtip.js"></script>
    <script type="text/javascript" src="assets/js/handlebars.min.js"></script>
    <script type="text/javascript" src="assets/js/fastclick.min.js"></script>
    <!-- <script type="text/javascript" src="assets/js/bluebird.min.js"></script> -->
    <script type="text/javascript" src="assets/js/typeahead.bundle.js"></script>
    <script type="text/javascript" src="assets/js/cytoscape-k-means.js"></script>


    <link href="https://fonts.googleapis.com/css?family=Metrophobic" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
    <link href="assets/css/mdi/css/materialdesignicons.min.css" media="all" rel="stylesheet" type="text/css" />
    <link href="assets/css/font-awesome-4.7.0/css/font-awesome.min.css" media="all" rel="stylesheet" type="text/css" />
    <link href="assets/css/jquery.qtip.min.css" rel="stylesheet" />
    <link href="assets/css/bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet" type="text/css" >
    <link href="assets/css/bootstrap-material-design/dist/css/bootstrap-material-design.css" rel="stylesheet" type="text/css" >
    <link href="assets/css/bootstrap-material-design/dist/css/ripples.min.css" rel="stylesheet" type="text/css" >
    
    <link href="assets/css/styles.css" rel="stylesheet" />

    <!-- Material Design for Bootstrap -->
    <script>
        $.material.input();
        $.material.checkbox();
    </script>

</head>

<body>    
    <div class="container-fluid">
        <row class="card jumbotron">
            <div class="col-md-12 col-lg-12 col-sm-12">
                <h2 class=" title">Mapping The Trump World</h2>
            </div>            
        </row>
        <row>
            <div class="col-md-8 col-lg-8 col-sm-8">
                <div class="card btn-group btn-group-justified">
                    <a href="javascript:void(0)" class="btn " id="graph_viz_btn">Trump World</a>
                    <a href="javascript:void(0)" class="btn " id="adj_matrix_btn">Adjacency Matrix</a>
                    <a href="javascript:void(0)" class="btn " id="rankings_btn">Rankings</a>
                    <a href="javascript:void(0)" class="btn " id="graph_data_btn">Graph Data</a>
                    <a href="javascript:void(0)" class="btn " id="help_btn">About</a>
                </div>
            </div>
            <div class="col-md-1 col-lg-1 col-sm-1 col-md-offset-1 col-lg-offset-1 col-sm-offset-1">                               
                <a href="javascript:void(0)" id="reset" class="card btn">
                    <i class="material-icons icon-sm">aspect_ratio</i>
                </a>             
            </div>
            <div class="col-md-1 col-lg-1 col-sm-1"> 
                <a href="javascript:void(0)" id="refresh" class="card btn">
                    <i class="material-icons icon-sm" >refresh</i>
                </a>
            </div>
            <div id="trigger" class="col-md-1 col-lg-1 col-sm-1 ">
                <a href="javascript:void(0)" class="btn btn-danger btn-raised">
                    <i class="material-icons icon-sm" >menu</i>
                </a>    
            </div>
            
        </row>
        <row>
            <div class="col-md-12 col-lg-12 col-sm-12">
                <div id="viz">
                    <div id="left" class="card">
                        <div id="cy_container">
                            <div id="cy"></div>                        
                        </div>
                    </div>
                    <div id="right">
                        <div id="path_info"></div>
                        <div id="node_info">
                            <div id="node_info_heading" ></div>
                            <div id="node_info_body" >
                                <div id="node-picture" class=""></div>
                                <div id="node-source"></div>                                
                            </div>
                        </div>
                        <div id="graph_legends">
                            Graph Legend Info needs to be here
                        </div> 
                    </div> 
                </div>                  
                <div id="adj_matrix_container">
                    <div id="adj_matrix">
                        <!-- <iframe src="adjacencyMatrix.html" style="width:100%;height:100%;overflow: scroll; border: none;"></iframe> -->                            
                    </div>
                </div>

                <div id="rankings_container">
                    <div id="rankings">
                        Rankings and Adjacency Matrix go here.
                    </div>
                </div>

                <div id="graph_data_container">
                    <div id="graph_data"></div>
                </div>

                <div id="help_container">
                    <div id="help">
                        Help the user figure this site out.
                    </div>
                </div>
            </div>
        </row>
    </div>
    <div class="panel panel-default" id="slider">
        <row class="vertical-align">
            <div class="col-md-2 col-lg-2 col-sm-2">
                <i class="material-icons search icon">search</i>
            </div>
            <div id="search">
                <div class="col-md-5 col-lg-5 col-sm-5">
                    <div class="form-group label-static">
                        <label for="startNode" class="control-label" >Start At</label>
                        <input type="text" class="form-control" id="startNode">
                    </div>
                </div>

                <div class="col-md-5 col-lg-5 col-sm-5">
                    <div class="form-group label-static search">
                        <label for="endNode" class="control-label">End At</label>
                        <input type="text" class="form-control" id="endNode">
                    </div>
                </div>
            </div>
        </row>
        <row class="vertical-align ">
            <div class="col-md-2 col-lg-2 col-sm-2">
                <i class="material-icons focusOn icon">zoom_in</i>
            </div>
            <div class="col-md-9 col-lg-9 col-sm-9">
                <div class="form-group label-static">
                    <label for="focusOn" class="control-label">Learn More About</label>
                    <input type="text" class="form-control" id="focusOn">
                </div>
            </div>
        </row>
        <row class="vertical-align ">
            <div class="col-md-2 col-lg-2 col-sm-2">
                <i class="mdi mdi-bullseye resize icon"></i>
            </div>
            <div class="col-md-9 col-lg-9 col-sm-9">
                <div class="form-group label-static">
                    <label for="resizeNodes" class="control-label">Reprioritize Graph By</label>
                    <select id="resizeNodes" class="form-control">
                        <option value="">Select</option>
                        <option value="degree"> Most Connected (Degree) </option>
                        <option value="betweeness"> Most Paths (Betweeness) </option>
                        <option value="closeness"> Most Reach (Closeness) </option>
                        <option value="pagerank"> Most Popular (Pagerank) </option>
                    </select>
                </div>
            </div>
        </row>
        <row class="vertical-align ">
            <div class="col-md-2 col-lg-2 col-sm-2">
                <i class="material-icons exportAs icon">file_download</i>
            </div>
            <div class="col-md-10 col-lg-10 col-sm-10">
                <div class="form-group label-static ">
                    <label for="exportAs" class="control-label">Export As</label>
                    <select id="exportAs" class="form-control">
                        <option value="">Select</option>
                        <option value="png"> PNG </option>
                        <option value="svg"> SVG </option>
                        <option value="graphml"> GraphML </option>
                    </select>
                </div>
            </div>
        </row>
        <row class="vertical-align ">
            <div class="col-md-2 col-lg-2 col-sm-2">
                <i class="mdi mdi-filter-outline filter icon"></i>
            </div>
            <div class="col-md-10 col-lg-10 col-sm-10">
                <div class="form-group label-static">
                <label for="filters" class="control-label">Filter / Remove</label>
                    <select id="filters" multiple="" class="form-control">
                        <option value=""> Select </option>
                        <option value="Person"> Person </option>
                        <option value="Organization"> Organization </option>
                        <option value="Agency"> Agency </option>
                        <option value="Contract"> Contract </option>
                        <option value="Country"> Country </option>
                    </select>                        
                </div>
            </div>
        </row>
    </div>
    <div id="loading">
        <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
        <div>Loading: Trump Network Data </div>
    </div>

    <script type="text/javascript">
        var win = $(window);
        
        var layoutPadding = 50;
        var aniDur = 500;
        var easing = 'linear';

        $(function() {          

            "use strict";
            
            
            var allNodes = null;
            var allEles = null;
            var lastHighlighted = null;
            var lastUnhighlighted = null;

            var graphP = $.ajax({
                url: 'assets/data/trump-world.json',
                type: 'GET',
                dataType: 'json'
            });
            // also get style via ajax
            var styleP = $.ajax({
                url: 'assets/graph-layout-styles.txt',
                type: 'GET',
                dataType: 'text'
            });
                        
            // when both graph export json and style loaded, init cy
            Promise.all([graphP, styleP]).then(initCy);

            function initCy(then) {
                console.log("In Init CY");

                var styleJson = then[1];
                var graphElements = then[0];

                var cy = window.cy = cytoscape({
                    headless: false,
                    styleEnabled: true,
                    container: $("#cy"),
                    elements: graphElements,
                    style: styleJson,
                    layout: layoutOptions,                    
                    motionBlur: true,
                    zoomingEnabled: true,
                    userZoomingEnabled: true,
                    panningEnabled: true,
                    userPanningEnabled: true,
                    boxSelectionEnabled: true,
                    selectionType: 'single',
                    touchTapThreshold: 8,
                    desktopTapThreshold: 4,
                    autolock: false,
                    autoungrabify: false,
                    autounselectify: false,
                    ready: function() {
                        //apply cytoscape bootstrap fix for container height
                        resize();

                        $('#graph_legends').show();
                        $('#path_info').hide();
                        $('#node_info').hide();
                        
                        allNodes = this.nodes();
                        allEles = this.elements();

                        this.elements().qtip({
                            content: {
                                title: function() { return this.data("label"); },
                                text: function() { 
                                    let x = (this.data("name") === undefined) ? '' : $.camelCase(this.data("name"));
                                    x += (this.data("purpose") === undefined) ? '' : $.camelCase(this.data("purpose"));
                                    return x; 
                                }                                                              
                            },
                            show: {
                              event: 'mouseover'
                            },
                            hide: {
                                event: 'mouseout'
                            },
                            position: {
                                my: 'top center',
                                at: 'bottom center'
                            },
                            style: {
                                classes: 'qtip-bootstrap',
                                tip: {
                                    width: 16,
                                    height: 8
                                },
                                'font-size': '8px'
                            }
                        });
                    } 

                }); //end cy

                /**********************************************************************/
                /*  SET LOADING COMPLETE                                              */
                /**********************************************************************/
                cy.on('layoutstop', function( event ) {
                    console.log("Layout rendering stopped");
                    $('#loading').addClass('loaded');
                });


                /**********************************************************************/
                /*  FADE ELEMENTS OUT USING ANIMATION                                 */
                /**********************************************************************/
                // var getFadePromise = function( ele, opacity ) {
                //     return ele.animation({
                //       style: { 'opacity': opacity },
                //       duration: aniDur
                //     }).play().promise();
                // };

                /**********************************************************************/
                /*  USER INTERACTION BASED EVENT LISTENERS                            */
                /**********************************************************************/
                // cy.on('tap', 'node', function( evt ){
                //     var n = evt.cyTarget;
                //     console.log(n.data());
                //     $('#graph_legends').hide();
                //     $('#path_info').hide();
                //     $('#node_info').html('');
                //     $('#node_info').show();
                //     $('#node_info_heading').html(n.data().name);
                //     $('#node_info_heading').html(n.data().name);
                // });

                /**********************************************************************/
                /*  FOCUS ON NODE - PAN & ZOOM TO SAID NODE                           */
                /**********************************************************************/
                $('#focusOn').on('change', function() {
                    console.log("In focusOn: " + $('#focusOn').val());
                    $("#slider").slideReveal("hide");
                    $('#graph_legends').hide();
                    $('#path_info').hide();
                    $('#node_info').html('');
                    $('#node_info').show();

                    let focusOn = cy.$("[name = '" + $("#focusOn").val().toUpperCase() + "']");
                    let pos = focusOn.renderedPosition();
                      
                    cy.elements().not( focusOn ).not( focusOn.neighbourhood() ).addClass('faded');                 
                    focusOn.addClass('focus');
                    lastHighlighted = focusOn;
                    focusOn.neighbourhood().addClass('focus-neighbour');
                    
                    cy.animate({
                        fit: {
                            eles: focusOn.neighbourhood(),
                            padding: 10
                        },
                        duration: 700,
                        easing: 'ease',
                        queue: true
                    });
                    let name = focusOn.data("name");
                    let type = focusOn.data("label");
                    let info = focusOn.data("fromSource");
                    if (info === undefined) {
                        info = "https://www.buzzfeed.com/johntemplon/help-us-map-trumpworld";
                    }
                    $('#node_info').html();
                    $('#node_info').html("<p class='bg-primary' style='font-size:20px;'>More about: " + name + "</p>" + "<p style='font-size:16px;'>Type of Entity: " + type + "</p><p style='font-size:16px;>Info: " + info + "</p>");

                }); //end focus on

                /**********************************************************************/
                /*      FILTER OUT NODE TYPES CHOSEN BY THE USER                      */
                /**********************************************************************/
                $("#filters").on('change', function() {
                    var noOrg         = !$("#filters").val().includes('Organization');
                    var noPerson      = !$("#filters").val().includes('Person');
                    var noAgency      = !$("#filters").val().includes('Agency');
                    var noCountry     = !$("#filters").val().includes('Country');
                    var noContract    = !$("#filters").val().includes('Contract');
                    cy.batch (function() {
                        allNodes.forEach ( n => { 
                            var type = n.data("label");                            
                            n.removeClass('filtered');
                            var filter = function(){
                              n.addClass('filtered');
                            };
                            if (n.data("label") === "Organization" && !noOrg 
                                || n.data("label") === "Person" && !noPerson
                                || n.data("label") === "Agency" && !noAgency
                                || n.data("label") === "Contract" && !noContract) {
                                filter();
                            }
                        });

                    });
                }); //end filter by

                /**********************************************************************************/
                /**     RESIZE NODES TO HIGHLIGHT DIFFERENT CENTRALITY MEASURES             *******/
                /**********************************************************************************/

                $('#resizeNodes').on('change', function() {
                    console.log("In resizeNodes: " + $('#resizeNodes').val());

                    switch ($('#resizeNodes').val()) {
                        case 'betweeness': 
                            cy.startBatch();
                            cy.nodes().removeClass('ccn-resize pr-resize');
                            cy.nodes().addClass('bc-resize');
                            cy.endBatch();
                            break;
                        case 'closeness': 
                            cy.startBatch();
                            cy.nodes().removeClass('bc-resize pr-resize');
                            cy.nodes().addClass('ccn-resize');
                            cy.endBatch();
                            break;
                        case 'pagerank': 
                            cy.startBatch();
                            cy.nodes().removeClass('bc-resize pr-resize');
                            cy.nodes().addClass('ccn-resize');
                            cy.endBatch();
                            break;
                        default:
                            cy.startBatch();
                            cy.nodes().removeClass('bc-resize ccn-resize pr-resize');
                            cy.endBatch();
                    }
                }); //end resize by

                /**********************************************************************************/
                /*  ASTAR IMPLEMENTATION -  FIND PATH TO GOAL NODE                              ***/
                /**********************************************************************************/ 
                $("#search").on('change', 'input', function() {

                    if ($("#startNode").val() && $("#endNode").val()) {
                        $("#slider").slideReveal("hide");
                        if (lastHighlighted != null) {
                            cy.elements().removeClass('path not-path focus focus-neighbour start end hidden faded highlighted');
                            lastHighlighted = null;
                        }
                       
                        let start = cy.$("[name = '" + $("#startNode").val().toUpperCase() + "']");
                        let end = cy.$("[name = '" + $("#endNode").val().toUpperCase() + "']");

                        // calculate shortest path
                        cy.startBatch();
                        
                        start.addClass('start');
                        end.addClass('end');

                        setTimeout (function() {
                             var aStar = cy.elements().aStar({
                                root: start,
                                goal: end,
                                directed: false,
                                weight: function( e ) { 
                                    return 1;
                                }
                            });                             
                            if ( !aStar.found ) {
                                $("body").removeClass('calc');
                                clear();

                                cy.endBatch();
                                return;
                            } else {
                                
                                $("#path_info").html('');
                                $('#graph_legends').hide();
                                $('#path_info').show();
                                $('#node_info').hide();
                                               
                                cy.elements().not( aStar.path ).addClass('not-path faded');    
                                aStar.path.addClass('path');
                                cy.animate({
                                    fit: {
                                        eles: aStar.path,
                                        padding: 20
                                    },
                                    duration: 700,
                                    easing: 'ease',
                                    queue: true
                                });

                                let pathTableColumns = ['ID', 'Type', 'Name', 'Source', 'Target', 'Info'];
                                let pathTableData = [];
                                aStar.path.jsons().forEach(d => {                                    
                                    pathTableData.push({
                                        'ID': d.data.id,
                                        'Type': d.data.label,
                                        'Name': d.data.name,
                                        'Source ID': d.data.source,
                                        'Target ID': d.data.target,
                                        'Info': d.data.fromSource                                        
                                    });    
                                    
                                });

                                tabulate("#path_info", pathTableData, pathTableColumns);
                                cy.endBatch();
                            }

                        }, 300);
                    }

                }); //end search


                /**********************************************************************/
                /*  CENTER AND RESET ZOOM OF THE VIEW PORT                            */
                /**********************************************************************/
                $("#reset").on('click', function() {
                    cy.batch(function() { 
                        cy.fit(cy.elements());
                    });
                    
                }); 

                /**********************************************************************/
                /*  REMOVE CSS CLASSES AND SPECIAL STYLES; RESTORE ORG POSITIONS      */
                /**********************************************************************/
                $("#refresh").on('click', function() {
                    $('body').removeClass('has-start has-end');
                    cy.batch(function() { 
                        cy.elements().removeClass('path not-path focus focus-neighbour start end hidden faded highlighted');
                    });
                    $('#graph_legends').show();
                    $('#path_info').hide();
                    $('#node_info').hide();
                    lastHighlighted = null;
                });         

            } //end init cy

            /**********************************************************************************/
            /*          TOP MENU & NON-CY EVENTS                                              */
            /**********************************************************************************/

            /**********************************************************************************/
            /*          BOOTSTRAP CY DIV FIX                                                  */
            /**********************************************************************************/
            var resize = function() {
                $("#right").height(win.innerHeight());
                $("#left").height(win.innerHeight());
                $("#cy_container").height(win.innerHeight() - 130);
                cy.resize();
            };

            win.resize(function() {
                resize()
            });

            /**********************************************************************************/
            /*          D3 TABULATE - PROVIDE CONTAINER DIV ID, DATA AND COLUMN NAMES         */
            /**********************************************************************************/
            d3.csv('assets/data/org-org-connections.csv',function (data) {
                var columns = ['Organization A','Organization B','Connection','Source(s)'];
                tabulate('#graph_data',data,columns);
            });

            /**********************************************************************************/
            /** RIGHT TO LEFT SLIDER - GRAPH ANALYSIS TOOLS                                  **/
            /**********************************************************************************/
            $('#slider').slideReveal({
                trigger: $("#trigger"),
                position: "right",
                width: "30%",
                top: 180,
                push: false,
                overlay: true,
                autoEscape: true                
            });

            /**********************************************************************/
            /*      ON CLICK OF TRUMP WORLD SHOW CYTOSCAPE CONTAINER              */
            /**********************************************************************/

            $("#graph_viz_btn").click(function() {
                $("#viz").show();
                $("#trigger").show();
                $('#reset').show();
                $('#refresh').show();
                $("#adj_matrix_container").hide();
                $("#graph_data_container").hide();
                $("#help_container").hide();
                $("#rankings_container").hide();    
            });

            /**********************************************************************/
            /*       ON CLICK OF RANKINGS SHOW RANKINGS CONTAINER                **/
            /**********************************************************************/

            $("#rankings_btn").click(function() {
                $("#viz").hide();
                $("#trigger").hide();
                $('#reset').hide();
                $('#refresh').hide();
                $("#adj_matrix_container").hide();
                $("#graph_data_container").hide();
                $("#help_container").hide();
                $("#rankings_container").show();    
            });

            /**********************************************************************/
            /*       ON CLICK OF DESCRIPTION SHOW DESCRIPTION CONTAINER           */
            /**********************************************************************/

            $("#adj_matrix_btn").click(function() {
                $("#viz").hide();
                $("#trigger").hide();
                $('#reset').hide();
                $('#refresh').hide();
                $("#adj_matrix_container").show();
                $("#graph_data_container").hide();
                $("#help_container").hide();
                $("#rankings_container").hide();    
            });

            /**********************************************************************/
            /*       ON CLICK OF GRAPH DATA SHOW GRAPH DATA CONTAINER             */
            /**********************************************************************/

            $("#graph_data_btn").click(function() {

                $("#viz").hide();
                $("#trigger").hide();
                $('#reset').hide();
                $('#refresh').hide();
                $("#adj_matrix_container").hide();
                $("#graph_data_container").show();
                $("#help_container").hide();
                $("#rankings_container").hide();

            });

            /**********************************************************************/
            /*          ON CLICK OF HELP SHOW HELP CONTAINER                      */
            /**********************************************************************/

            $("#help_btn").click(function() {
                $("#viz").hide();
                $("#trigger").hide();
                $('#reset').hide();
                $('#refresh').hide();
                $("#adj_matrix_container").hide();
                $("#graph_data_container").hide();
                $("#help_container").show();
                $("#rankings_container").hide();    
            });

            /**********************************************************************/
            /*          QTIPS FOR REFRESH AND REFIT                               */
            /**********************************************************************/

            $("#refresh").qtip({
                content: {
                    text: "Clear Styles"
                },
                position: {
                    my: 'top center',
                    at: 'bottom center',
                    adjust: {
                        method: 'shift'
                    },
                    viewport: true
                },
                show: {
                  event: 'mouseover'
                },
                style: {
                    classes: 'qtip-bootstrap',
                    tip: {
                        width: 16,
                        height: 8
                    }
                }
            });

            $("#reset").qtip({
                content: {
                    text: "Fit Graph to Screen"
                },
                position: {
                    my: 'top center',
                    at: 'bottom center',
                    adjust: {
                        method: 'shift'
                    },
                    viewport: true
                },
                show: {
                  event: 'mouseover'
                },
                style: {
                    classes: 'qtip-bootstrap',
                    tip: {
                        width: 16,
                        height: 8
                    }
                }
            });
        });

    </script>
</body>

</html>
