<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="user-scalable=no, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, minimal-ui">

    <title>Trump World</title>
    <script type="text/javascript" src="assets/js/fastclick.min.js"></script>
    <script type="text/javascript" src="assets/js/jquery/dist/jquery.min.js"></script>
    <script src="assets/css/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
    <script src="assets/css/bootstrap-material-design/dist/js/material.min.js"></script>
    <script src="assets/css/bootstrap-material-design/dist/js/ripples.min.js"></script>
    <script type="text/javascript" src="assets/js/ngraphForceLayoutOptions.js"></script>
    <script type="text/javascript" src="assets/js/cytoscape/dist/cytoscape.min.js"></script>
    <script type="text/javascript" src="assets/js/cytoscape-graphml/cytoscape-graphml.js"></script>
    <script type="text/javascript" src="assets/js/cytoscape-ngraph.forcelayout/cytoscape-ngraph.forcelayout.js"></script>
    <script type="text/javascript" src="assets/js/cytoscape-cola/cola.js"></script>
    <script type="text/javascript" src="assets/js/cytoscape-cola/cytoscape-cola.js"></script>
    <script type="text/javascript" src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="assets/js/graphDataView.js"></script>
    <script type="text/javascript" src="assets/js/slidereveal.js"></script>
    <script type="text/javascript" src="assets/js/jquery.qtip.min.js"></script>
    <link href="assets/css/jquery.qtip.min.css" rel="stylesheet" />
    <script type="text/javascript" src="assets/js/cytoscape-qtip.js"></script>
    <script type="text/javascript" src="assets/js/handlebars.min.js"></script>
    <script type="text/javascript" src="assets/js/fastclick.min.js"></script>
    <!-- <script type="text/javascript" src="assets/js/bluebird.min.js"></script> -->
    <script type="text/javascript" src="assets/js/typeahead.bundle.js"></script>
    <script type="text/javascript" src="assets/js/cytoscape-k-means.js"></script>


    <link href="https://fonts.googleapis.com/css?family=Metrophobic" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link href="assets/css/mdi/css/materialdesignicons.min.css" media="all" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/css/bootstrap-multiselect.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.min.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="assets/css/bootstrap-3.3.7-dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="assets/css/bootstrap-material-design/dist/css/bootstrap-material-design.css">
    <link rel="stylesheet" type="text/css" href="assets/css/bootstrap-material-design/dist/css/ripples.min.css">
    
    <link href="assets/css/styles.css" rel="stylesheet" />

    <!-- Material Design for Bootstrap -->
    <script>
        $.material.input();
        $.material.checkbox();
    </script>

</head>

<body>
    <div class="container-fluid">
        <div id="loading">
            <span class="fa fa-refresh fa-spin"></span>
        </div>
        <row class="card jumbotron">
            <div class="col-md-12 col-lg-12 col-sm-12">
                <h2 class=" title">Mapping The Trump World</h2>
            </div>            
        </row>
        <row>
            <div class="col-md-8 col-lg-8 col-sm-8">
                <div class="card btn-group btn-group-justified">
                    <a href="javascript:void(0)" class="btn " id="graph_viz_btn">Trump World</a>
                    <a href="javascript:void(0)" class="btn " id="adj_matrix_btn">Adjacency Matrix</a>
                    <a href="javascript:void(0)" class="btn " id="rankings_btn">Rankings</a>
                    <a href="javascript:void(0)" class="btn " id="graph_data_btn">Graph Data</a>
                    <a href="javascript:void(0)" class="btn " id="help_btn">About</a>
                </div>
            </div>
            <div class="col-md-1 col-lg-1 col-sm-1 col-md-offset-1 col-lg-offset-1 col-sm-offset-1"> 
                <div class="btn-group btn-group-justified">               
                    <button id="reset" class="btn btn-sm"><i class="material-icons ">aspect_ratio</i></button>                
                    <button id="refresh" class="btn btn-sm"><i class="material-icons" >refresh</i></button>
                </div>                 
            </div>
            <div id="trigger" class="col-md-2 col-lg-2 col-sm-2 ">
                <a href="javascript:void(0)" class="card btn btn-danger btn-lg btn-block btn-raised">Analysis</a>    
            </div>
            
        </row>
        <row id="home">
            <div class="col-md-12 col-lg-12 col-sm-12">
                <div class="panel panel-primary">
                    <div id="cy_container">
                        <div id="cy"></div>
                    </div>                    
                    <div id="adj_matrix_container">
                        <div id="adj_matrix">                            
                        </div>
                    </div>

                    <div id="rankings_container">
                        <div id="rankings">
                            Rankings and Adjacency Matrix go here.
                        </div>
                    </div>

                    <div id="graph_data_container">
                        <div id="graph_data">
                            
                        </div>
                    </div>

                    <div id="help_container">
                        <div id="help">
                            Help the user figure this site out.
                        </div>
                    </div>
                </div>
            </div>            
        </row>
    </div>
    <div class="card" id="slider">
        <row class="vertical-align">
            <div class="col-md-2 col-lg-2 col-sm-2">
                <i class="material-icons search icon">search</i>
            </div>
            <div id="search">
                <div class="col-md-5 col-lg-5 col-sm-5">
                    <div class="form-group label-static">
                        <label for="startNode" class="control-label" ><span class="search">Start At</label>
                        <input type="text" class="form-control" id="startNode" data-ripple-color="#034AA0">
                    </div>
                </div>

                <div class="col-md-5 col-lg-5 col-sm-5">
                    <div class="form-group label-static search" data-ripple-color="#034AA0">
                        <label for="endNode" class="control-label" style="color:#034AA0;"><span class="search">End At</label>
                        <input type="text" class="form-control" id="endNode">
                    </div>
                </div>
            </div>
        </row>
        <row class="vertical-align">
            <div class="col-md-2 col-lg-2 col-sm-2">
                <i class="material-icons focusOn icon">zoom_in</i>
            </div>
            <div class="col-md-9 col-lg-9 col-sm-9">
                <div class="form-group label-static">
                    <label for="focusOn" class="control-label"><span class="focusOn">Focus On</span></label>
                    <input type="text" class="form-control" id="focusOn">
                </div>
            </div>
        </row>
        <row class="vertical-align ">
            <div class="col-md-2 col-lg-2 col-sm-2">
                <i class="mdi mdi-bullseye resize icon"></i>
            </div>
            <div class="col-md-10 col-lg-10 col-sm-10">
                <div class="form-group label-static">
                    <label for="resizeNodes" class="control-label"><span class="resize">Resize Nodes</span></label>
                    <select id="resizeNodes" class="form-control">
                        <option value="">Select</option>
                        <option value="degree"> Most Connected (Degree) </option>
                        <option value="betweeness"> Most Paths (Betweeness) </option>
                        <option value="closeness"> Most Reach (Closeness) </option>
                        <option value="pagerank"> Most Popular (Pagerank) </option>
                    </select>
                </div>
            </div>
        </row>
        <row class="vertical-align ">
            <div class="col-md-2 col-lg-2 col-sm-2">
                <i class="mdi mdi-filter-outline filter icon"></i>
            </div>
            <div class="col-md-10 col-lg-10 col-sm-10">
                <div class="form-group label-static">
                <label for="filters" class="control-label"><span class="filter">Filter / Remove</span></label>
                    <select id="filters" multiple="" class="form-control">
                        <option value=""> Select </option>
                        <option value="Person"> Person </option>
                        <option value="Organization"> Organization </option>
                        <option value="Agency"> Agency </option>
                        <option value="Contract"> Contract </option>
                        <option value="Country"> Country </option>
                    </select>                        
                </div>
            </div>
        </row>
        <row class="vertical-align ">
            <div class="col-md-2 col-lg-2 col-sm-2">
                <i class="material-icons exportAs icon">file_download</i>
            </div>
            <div class="col-md-10 col-lg-10 col-sm-10">
                <div class="form-group label-static ">
                    <label for="exportAs" class="control-label"><span class="exportAs">Export As</span></label>
                    <select id="exportAs" class="form-control">
                        <option value="">Select</option>
                        <option value="png"> PNG </option>
                        <option value="svg"> SVG </option>
                        <option value="graphml"> GraphML </option>
                    </select>
                </div>
            </div>
        </row>
    </div>

    <script type="text/javascript">
        var win = $(window);
        var allNodes = null;
        var allEles = null;
        var lastHighlighted = null;
        var lastUnhighlighted = null;
        $('#slider').hide();

        /*****************************************/
        /**** Handlebar Template for Node Info ***/
        // var infoTemplate = Handlebars.compile([
        //     '<p class="ac-name">{{name}}</p>',
        //     '<p class="ac-node-type"><i class="fa fa-info-circle"></i> {{NodeTypeFormatted}} {{#if Type}}({{Type}}){{/if}}</p>',
        //     '{{#if Milk}}<p class="ac-milk"><i class="fa fa-angle-double-right"></i> {{Milk}}</p>{{/if}}',
        //     '{{#if Country}}<p class="ac-country"><i class="fa fa-map-marker"></i> {{Country}}</p>{{/if}}',
        //     '<p class="ac-more"><i class="fa fa-external-link"></i> <a target="_blank" href="https://duckduckgo.com/?q={{name}}">More information</a></p>'
        //   ].join(''));

        $(function() {          

            "use strict";
            var $loading = $('#loading');
    

            var graphP = $.ajax({
                url: 'assets/data/trump-world.json',
                type: 'GET',
                dataType: 'json'
            });
            // also get style via ajax
            var styleP = $.ajax({
                url: 'assets/graph-layout-styles.txt',
                type: 'GET',
                dataType: 'text'
            });

            var getFadePromise = function( ele, opacity ){
                return ele.animation({
                  style: { 'opacity': opacity },
                  duration: aniDur
                }).play().promise();
            };

            var restoreElesPositions = function( nhood ){
                return Promise.all( nhood.map(function( ele ){
                  var p = ele.data('orgPos');

                  return ele.animation({
                    position: { x: p.x, y: p.y },
                    duration: aniDur,
                    easing: easing
                  }).play().promise();
                }));
            };
                        
            // when both graph export json and style loaded, init cy
            Promise.all([graphP, styleP]).then(initCy);

            function initCy(then) {
                console.log("In Init CY");

                var styleJson = then[1];
                var graphElements = then[0];                
                var cy = window.cy = cytoscape({
                    headless: false,
                    styleEnabled: true,
                    container: $("#cy"),
                    elements: graphElements,
                    style: styleJson,
                    layout: layoutOptions,                    
                    motionBlur: true,
                    zoom: 0.05,
                    pan: { x: 0, y: 0 },
                    minZoom: 1e-50,
                    maxZoom: 1e50,
                    zoomingEnabled: true,
                    userZoomingEnabled: true,
                    panningEnabled: true,
                    userPanningEnabled: true,
                    boxSelectionEnabled: true,
                    selectionType: 'single',
                    touchTapThreshold: 8,
                    desktopTapThreshold: 4,
                    autolock: false,
                    autoungrabify: false,
                    autounselectify: false,
                    ready: function() {
                        $("#cy_container").height(win.innerHeight() - 130);
                        this.resize();
                        allNodes = this.nodes();
                        allEles = this.elements();
                        $loading.addClass('loaded');
                        $('#slider').show();
                        this.center();
                        this.elements().qtip({
                            content: {
                                title: function() { return this.data("label"); },
                                text: function() { 
                                    let x = (this.data("name") === undefined) ? '' : 'Name: ' + this.data("name");
                                    x += (this.data("purpose") === undefined) ? '' : 'Purpose: ' + this.data("purpose");
                                    return x; 
                                }                                                              
                            },
                            position: {
                                my: 'top center',
                                at: 'bottom center'
                            },
                            style: {
                                classes: 'qtip-bootstrap',
                                tip: {
                                    width: 16,
                                    height: 8
                                }
                            }
                        });
                    } 

                });

                // cy.pon('layoutstop').then(function( event ){

                //     // Input parameters to clustering algorithm
                //     var options = {
                //         k: 4,
                //         distance: "euclidean",
                //         maxIterations: 12
                //     };

                //     // Run clustering algorithm on graph nodes
                //     var clusters = cy.elements().kMeans( options );

                //     // Assign random colors to each cluster!
                //     if (clusters && clusters.length > 0) {
                //         for (var c = 0; c < clusters.length; c++) {
                //             clusters[c].style( 'background-color', '#' + Math.floor(Math.random()*16777215).toString(16) );
                //         }
                //     }
                // });
                                         

                win.resize(function() {
                    $("#cy_container").height(win.innerHeight() - 130);
                    cy.resize();
                });

                d3.csv('assets/data/org-org-connections.csv',function (data) {
                    var columns = ['Organization A','Organization B','Connection','Source(s)'];
                    tabulate('#graph_data',data,columns);
                });

                $('#slider').slideReveal({
                    trigger: $("#trigger"),
                    position: "right",
                    width: "26%",
                    top: 180,
                    push: false,
                    overlay: true,
                    autoEscape: true                
                });


                /**********************************************************************/
                /*** On Click of Trump World show Cytoscape Container       ***********/

                $("#graph_viz_btn").click(function() {
                    $("#cy_container").show();
                    $("#trigger").show();
                    $('#reset').show();
                    $('#refresh').show();
                    $("#adj_matrix_container").hide();
                    $("#graph_data_container").hide();
                    $("#help_container").hide();
                    $("#rankings_container").hide();    
                });

                /**********************************************************************/
                /*** On Click of Rankings show Rankings Container           ***********/

                $("#rankings_btn").click(function() {
                    $("#cy_container").hide();
                    $("#trigger").hide();
                    $('#reset').hide();
                    $('#refresh').hide();
                    $("#adj_matrix_container").hide();
                    $("#graph_data_container").hide();
                    $("#help_container").hide();
                    $("#rankings_container").show();    
                });

                /**********************************************************************/
                /*** On Click of Description show Description Container           ***********/

                $("#adj_matrix_btn").click(function() {
                    $("#cy_container").hide();
                    $("#trigger").hide();
                    $('#reset').hide();
                    $('#refresh').hide();
                    $("#adj_matrix_container").show();
                    $("#graph_data_container").hide();
                    $("#help_container").hide();
                    $("#rankings_container").hide();    
                });

                /**********************************************************************/
                /*** On Click of Graph Data show Graph Data Container           ***********/

                $("#graph_data_btn").click(function() {

                    $("#cy_container").hide();
                    $("#trigger").hide();
                    $('#reset').hide();
                    $('#refresh').hide();
                    $("#adj_matrix_container").hide();
                    $("#graph_data_container").show();
                    $("#help_container").hide();
                    $("#rankings_container").hide();

                });

                /**********************************************************************/
                /*** On Click of Help show Help Container           ***********/

                $("#help_btn").click(function() {
                    $("#cy_container").hide();
                    $("#trigger").hide();
                    $('#reset').hide();
                    $('#refresh').hide();
                    $("#adj_matrix_container").hide();
                    $("#graph_data_container").hide();
                    $("#help_container").show();
                    $("#rankings_container").hide();    
                });

                $("#reset").on('click', function() {
                    cy.zoom(0.05);
                    cy.center();
                    this.blur();
                }); 

                $("#refresh").on('click', function() {
                    $('body').removeClass('has-start has-end');
                    cy.elements().removeClass('path not-path start end hidden');
                    cy.layout(layoutOptions);
                });         

                /**********************************************************************/
                /*      Apply Node Type Based Filter                                  */
                $("#filters").on('change', function() {
                    var noOrg         = !$("#filters").val().includes('Organization');
                    var noPerson      = !$("#filters").val().includes('Person');
                    var noAgency      = !$("#filters").val().includes('Agency');
                    var noCountry     = !$("#filters").val().includes('Country');
                    var noContract    = !$("#filters").val().includes('Contract');
                    cy.batch (function() {
                        allNodes.forEach ( n => { 
                            var type = n.data("label");                            
                            n.removeClass('filtered');
                            var filter = function(){
                              n.addClass('filtered');
                            };
                            if (n.data("label") === "Organization" && !noOrg 
                                || n.data("label") === "Person" && !noPerson
                                || n.data("label") === "Agency" && !noAgency
                                || n.data("label") === "Contract" && !noContract) {
                                filter();
                            }
                        });

                    });
                });              

                $("#search").on('change', 'input', function() {
                    if ($("#startNode").val() && $("#endNode").val()) {
                       
                        let start = cy.$("[name = '" + $("#startNode").val().toUpperCase() + "']");
                        let end = cy.$("[name = '" + $("#endNode").val().toUpperCase() + "']");

                        // calculate shortest path
                        cy.startBatch();
                        
                        start.addClass('start');
                        end.addClass('end');

                        setTimeout (function() {
                             var aStar = cy.elements().aStar({
                                root: start,
                                goal: end,
                                directed: false,
                                weight: function( e ) { 
                                    return 1;
                                      // if( e.data('is_walking') ){
                                      //   return 0.25; // assume very little time to walk inside stn
                                      // }
                                      
                                      // return e.data('is_bullet') ? 1 : 3; // assume bullet is ~3x faster
                                }
                            });                             
                            if ( !aStar.found ) {
                                $("body").removeClass('calc');
                                clear();

                                cy.endBatch();
                                return;
                            } else {
                                $("#slider").hide();
                                $("#trigger").disable();
                                var circleLayoutOptions = {
                                    name: 'circle',
                                    fit: false, // whether to fit the viewport to the graph
                                    istartAngle: 3 / 2 * Math.PI,
                                    // directed: false, // whether the tree is directed downwards (or edges can point in any direction if false)
                                    // padding: 30, // padding on fit
                                    // circle: true, // put depths in concentric circles if true, put depths top down if false
                                    // spacingFactor: 1.0, // positive spacing factor, larger => more space between nodes (N.B. n/a if causes overlap)
                                    avoidOverlap: true // prevents node overlap, may overflow boundingBox if not enough space
                                };               
                                cy.elements().not( aStar.path ).addClass('hidden');    
                                aStar.path.addClass('path');
                                let layout = aStar.path.layout(circleLayoutOptions);
                                cy.pan({x: 30, y:50});
                                cy.zoomingEnabled(false);

                                cy.layout();
                                let pathTableColumns = ['ID', 'Type', 'Name', 'Closeness', 'Degree', 'Betweeness', 'Pagerank'];
                                let pathTableData = [];
                                aStar.path.nodes().jsons().forEach(d => {
                                    pathTableData.push({
                                        'ID': d.data.id,
                                        'Type': d.data.label,
                                        'Name': d.data.name,
                                        'Closeness': d.data.ccn,
                                        'Degree': d.data.dcn,
                                        'Betweeness': d.data.bc,
                                        'Pagerank': d.data.pr
                                    });    
                                    
                                });
                                tabulate("#cy_container", pathTableData, pathTableColumns);
                                cy.endBatch();
                                $('body').removeClass('calc');
                            }

                        }, 300);
                    }

                });

                $('#resizeNodes').on('change', function() {
                    console.log("In resizeNodes: " + $('#resizeNodes').val());
                    switch ($('#resizeNodes').val()) {
                        case 'betweeness': 
                            cy.startBatch();
                            cy.nodes().removeClass('ccn-resize pr-resize');
                            cy.nodes().addClass('bc-resize');
                            cy.endBatch();
                            break;
                        case 'closeness': 
                            cy.startBatch();
                            cy.nodes().removeClass('bc-resize pr-resize');
                            cy.nodes().addClass('ccn-resize');
                            cy.endBatch();
                            break;
                        case 'pagerank': 
                            cy.startBatch();
                            cy.nodes().removeClass('bc-resize pr-resize');
                            cy.nodes().addClass('ccn-resize');
                            cy.endBatch();
                            break;
                        default:
                            cy.startBatch();
                            cy.nodes().removeClass('bc-resize ccn-resize pr-resize');
                            cy.endBatch();
                    }
                });


                $('#focusOn').on('change', function() {
                    console.log("In focusOn: " + $('#focusOn').val());
                    let focusOn = cy.$("[name = '" + $("#focusOn").val().toUpperCase() + "']");
                    let pos = focusOn.position();
                    cy.elements().not( focusOn.neighbourhood() ).addClass('not-path'); 
                    focusOn.addClass('start');
                    cy.pan(pos);
                    cy.zoom(1);
                });

            }


        });

    </script>
</body>

</html>
